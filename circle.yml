machine:
  environment:
    DEPLOY_TOOLKIT: $HOME/deploy_toolkit
    FAILURE_FILE: /tmp/build_failures.txt
    DEPENDENCY_LOG:  $CIRCLE_ARTIFACTS/dependency.log
    TESTING_LOG:  $CIRCLE_ARTIFACTS/testing.log
    LOG_LEVEL: DEBUG
    DEPLOY_TOOLKIT_BRANCH: <DEPLOY_TOOLKIT_BRANCH>
  node:
    version: 4.5.0
  ruby:
    version: 2.2.7

dependencies:
  pre:
    - |
      if [ "$DEPLOY_TOOLKIT_BRANCH" == "<DEPLOY_TOOLKIT_BRANCH>" ]; then DEPLOY_TOOLKIT_BRANCH="master"; fi
      echo "Checking out branch: $DEPLOY_TOOLKIT_BRANCH\n"
      git clone -b $DEPLOY_TOOLKIT_BRANCH git@github.com:loanlifecycle/deploy_toolkit.git $DEPLOY_TOOLKIT
    - $DEPLOY_TOOLKIT/scripts/installation/install_dependencies_for_python.sh
    - cd $DEPLOY_TOOLKIT && npm install -g
  override:
    - sfdeploy -d report_build_info -lt off || ( touch $FAILURE_FILE && exit 1 )
    - sfdeploy -d npm_install -s ui/ -lt file -ll $LOG_LEVEL -lp $DEPENDENCY_LOG -ci || ( touch $FAILURE_FILE && exit 1 )
  cache_directories:
    - "/opt/circleci/python/2.7.11/lib/python2.7/site-packages"
    - "~/design-system/node_modules"

test:
  override:
    - npm run dist || ( touch $FAILURE_FILE && exit 1 )
  post:
    - $DEPLOY_TOOLKIT/scripts/build_notifications.py
